<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>High-Precision Vedic Astrology Ephemeris</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #7e22ce 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #2563eb 0%, #7e22ce 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        header p {
            font-size: 1.1em;
            opacity: 0.95;
        }

        .controls {
            padding: 30px;
            background: #f8fafc;
            border-bottom: 2px solid #e2e8f0;
        }

        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        .control-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #334155;
            font-size: 0.95em;
        }

        .control-group input,
        .control-group select {
            padding: 12px;
            border: 2px solid #cbd5e1;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
        }

        .control-group input:focus,
        .control-group select:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .ayanamsa-section {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            border: 2px solid #cbd5e1;
        }

        .ayanamsa-section h3 {
            margin-bottom: 15px;
            color: #1e293b;
        }

        .custom-ayanamsa {
            display: none;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .custom-ayanamsa.active {
            display: grid;
        }

        .custom-ayanamsa input {
            padding: 10px;
            border: 2px solid #cbd5e1;
            border-radius: 6px;
            text-align: center;
        }

        .ayanamsa-display {
            margin-top: 15px;
            padding: 15px;
            background: #f1f5f9;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 1.1em;
            font-weight: 600;
            color: #0f172a;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        button {
            padding: 15px 30px;
            font-size: 1em;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
        }

        .btn-primary {
            background: linear-gradient(135deg, #2563eb 0%, #7e22ce 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(37, 99, 235, 0.4);
        }

        .btn-secondary {
            background: #64748b;
            color: white;
        }

        .btn-secondary:hover {
            background: #475569;
        }

        .btn-primary:disabled {
            background: #94a3b8;
            cursor: not-allowed;
            transform: none;
        }

        .results {
            padding: 30px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #2563eb;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            display: none;
            padding: 20px;
            background: #fee2e2;
            border: 2px solid #ef4444;
            border-radius: 8px;
            color: #991b1b;
            margin-bottom: 20px;
        }

        .error.active {
            display: block;
        }

        .info-panel {
            margin-bottom: 20px;
            padding: 15px;
            background: #eff6ff;
            border-left: 4px solid #2563eb;
            border-radius: 6px;
        }

        .info-panel h3 {
            margin-bottom: 10px;
            color: #1e40af;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        thead {
            background: linear-gradient(135deg, #1e40af 0%, #7e22ce 100%);
            color: white;
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #e2e8f0;
        }

        tbody tr:hover {
            background: #f8fafc;
        }

        .planet-name {
            font-weight: 600;
            font-size: 1.05em;
        }

        .sun-moon { color: #f59e0b; }
        .inner-planet { color: #10b981; }
        .outer-planet { color: #3b82f6; }
        .node { color: #8b5cf6; }

        .dms-value {
            font-family: 'Courier New', monospace;
            font-size: 0.95em;
            white-space: nowrap;
        }

        .retrograde {
            color: #dc2626;
            font-weight: 700;
        }

        .nakshatra {
            font-style: italic;
            color: #6366f1;
        }

        .rashi {
            font-weight: 600;
            color: #059669;
        }

        .toggle-options {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
        }

        .toggle-options label {
            display: inline-flex;
            align-items: center;
            margin-right: 20px;
            cursor: pointer;
        }

        .toggle-options input[type="checkbox"] {
            margin-right: 8px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        footer {
            padding: 20px;
            text-align: center;
            background: #f8fafc;
            color: #64748b;
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 1.8em;
            }

            .control-grid {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-direction: column;
            }

            table {
                font-size: 0.85em;
            }

            th, td {
                padding: 8px;
            }
        }

        @media print {
            body {
                background: white;
            }

            .controls, .button-group, .toggle-options {
                display: none;
            }
        }

        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
            border-bottom: 1px dotted #999;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #1f2937;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.85em;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* East Indian Chart Styles */
        .chart-container {
            margin-top: 30px;
            padding: 30px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .chart-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .chart-header h2 {
            color: #1e40af;
            margin-bottom: 10px;
        }

        .chart-info {
            font-size: 0.95em;
            color: #64748b;
        }

        #horoscopeChart {
            display: block;
            margin: 0 auto;
            max-width: 600px;
            width: 100%;
            height: auto;
        }

        .location-section {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            border: 2px solid #cbd5e1;
        }

        .location-section h3 {
            margin-bottom: 15px;
            color: #1e293b;
        }

        .location-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        @media (max-width: 768px) {
            .location-grid {
                grid-template-columns: 1fr;
            }

            #horoscopeChart {
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üåü High-Precision Vedic Astrology Ephemeris üåü</h1>
            <p>Real-time Planetary Positions ‚Ä¢ NASA JPL Horizons & VSOP87 ‚Ä¢ Arc-Second Accuracy</p>
            <p id="currentDateTime"></p>
        </header>

        <div class="controls">
            <div class="control-grid">
                <div class="control-group">
                    <label for="dateInput">Date:</label>
                    <input type="date" id="dateInput">
                </div>
                <div class="control-group">
                    <label for="timeInput">Time (HH:MM:SS):</label>
                    <input type="time" id="timeInput" step="1">
                </div>
                <div class="control-group">
                    <label for="timezoneInput">Timezone:</label>
                    <select id="timezoneInput">
                        <option value="UTC">UTC</option>
                        <option value="America/New_York">Eastern Time (EST/EDT)</option>
                        <option value="America/Chicago">Central Time (CST/CDT)</option>
                        <option value="America/Denver">Mountain Time (MST/MDT)</option>
                        <option value="America/Los_Angeles">Pacific Time (PST/PDT)</option>
                        <option value="Europe/London">London (GMT/BST)</option>
                        <option value="Europe/Paris">Paris (CET/CEST)</option>
                        <option value="Asia/Kolkata" selected>India (IST - UTC+5:30)</option>
                        <option value="Asia/Dubai">Dubai (GST - UTC+4)</option>
                        <option value="Asia/Tokyo">Tokyo (JST - UTC+9)</option>
                        <option value="Australia/Sydney">Sydney (AEST)</option>
                    </select>
                </div>
            </div>

            <div class="ayanamsa-section">
                <h3>Ayanamsa Configuration</h3>
                <div class="control-group">
                    <label for="ayanamsaType">
                        Ayanamsa Type:
                        <span class="tooltip">‚ìò
                            <span class="tooltiptext">Different systems for calculating precession of equinoxes</span>
                        </span>
                    </label>
                    <select id="ayanamsaType">
                        <option value="lahiri">Lahiri (Chitrapaksha) - Most Common</option>
                        <option value="raman">Raman</option>
                        <option value="krishnamurti">Krishnamurti (KP)</option>
                        <option value="yukteshwar">Yukteshwar</option>
                        <option value="custom">Custom (Manual Input)</option>
                    </select>
                </div>
                <div class="custom-ayanamsa" id="customAyanamsaInputs">
                    <div class="control-group">
                        <label>Degrees:</label>
                        <input type="number" id="customDeg" min="0" max="360" value="24">
                    </div>
                    <div class="control-group">
                        <label>Minutes:</label>
                        <input type="number" id="customMin" min="0" max="59" value="8">
                    </div>
                    <div class="control-group">
                        <label>Seconds:</label>
                        <input type="number" id="customSec" min="0" max="59" step="0.01" value="30">
                    </div>
                </div>
                <div class="ayanamsa-display" id="ayanamsaDisplay">
                    Ayanamsa: --¬∞ --' --"
                </div>
            </div>

            <div class="location-section">
                <h3>Birth Chart Location (for Ascendant & Houses)</h3>
                <div class="location-grid">
                    <div class="control-group">
                        <label for="latitudeInput">
                            Latitude:
                            <span class="tooltip">‚ìò
                                <span class="tooltiptext">Positive for North, Negative for South (e.g., 28.6139 for Delhi)</span>
                            </span>
                        </label>
                        <input type="number" id="latitudeInput" step="0.0001" placeholder="28.6139" value="28.6139">
                    </div>
                    <div class="control-group">
                        <label for="longitudeInput">
                            Longitude:
                            <span class="tooltip">‚ìò
                                <span class="tooltiptext">Positive for East, Negative for West (e.g., 77.2090 for Delhi)</span>
                            </span>
                        </label>
                        <input type="number" id="longitudeInput" step="0.0001" placeholder="77.2090" value="77.2090">
                    </div>
                </div>
                <div style="margin-top: 15px; padding: 12px; background: #eff6ff; border-radius: 6px; font-size: 0.9em;">
                    <strong>Popular Cities:</strong>
                    <div style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 10px;">
                        <button class="btn-secondary" style="padding: 6px 12px; font-size: 0.85em;" onclick="setLocation(28.6139, 77.2090)">Delhi</button>
                        <button class="btn-secondary" style="padding: 6px 12px; font-size: 0.85em;" onclick="setLocation(19.0760, 72.8777)">Mumbai</button>
                        <button class="btn-secondary" style="padding: 6px 12px; font-size: 0.85em;" onclick="setLocation(13.0827, 80.2707)">Chennai</button>
                        <button class="btn-secondary" style="padding: 6px 12px; font-size: 0.85em;" onclick="setLocation(22.5726, 88.3639)">Kolkata</button>
                        <button class="btn-secondary" style="padding: 6px 12px; font-size: 0.85em;" onclick="setLocation(12.9716, 77.5946)">Bangalore</button>
                        <button class="btn-secondary" style="padding: 6px 12px; font-size: 0.85em;" onclick="setLocation(40.7128, -74.0060)">New York</button>
                        <button class="btn-secondary" style="padding: 6px 12px; font-size: 0.85em;" onclick="setLocation(51.5074, -0.1278)">London</button>
                    </div>
                </div>
            </div>

            <div class="location-section">
                <h3>Calculation Options</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="control-group">
                        <label style="margin-bottom: 12px; display: block;">
                            Data Source:
                            <span class="tooltip">‚ìò
                                <span class="tooltiptext">NASA JPL Horizons for real-time data, Local for offline VSOP87 calculations</span>
                            </span>
                        </label>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <label style="display: flex; align-items: center; cursor: pointer; padding: 8px; background: white; border-radius: 6px; border: 2px solid #cbd5e1;">
                                <input type="radio" name="dataSource" value="nasa" id="dataSourceNASA" checked style="margin-right: 10px; width: 18px; height: 18px; cursor: pointer;">
                                <span style="font-weight: 600;">Use NASA JPL Horizons API</span>
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer; padding: 8px; background: white; border-radius: 6px; border: 2px solid #cbd5e1;">
                                <input type="radio" name="dataSource" value="local" id="dataSourceLocal" style="margin-right: 10px; width: 18px; height: 18px; cursor: pointer;">
                                <span style="font-weight: 600;">Use Local Calculations (VSOP87)</span>
                            </label>
                        </div>
                    </div>
                    <div class="control-group">
                        <label style="margin-bottom: 12px; display: block;">
                            Coordinate System:
                            <span class="tooltip">‚ìò
                                <span class="tooltiptext">Tropical for Western astrology, Sidereal for Vedic astrology</span>
                            </span>
                        </label>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <label style="display: flex; align-items: center; cursor: pointer; padding: 8px; background: white; border-radius: 6px; border: 2px solid #cbd5e1;">
                                <input type="radio" name="coordSystem" value="sidereal" id="coordSystemSidereal" checked style="margin-right: 10px; width: 18px; height: 18px; cursor: pointer;">
                                <span style="font-weight: 600;">Use Sidereal (Vedic)</span>
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer; padding: 8px; background: white; border-radius: 6px; border: 2px solid #cbd5e1;">
                                <input type="radio" name="coordSystem" value="tropical" id="coordSystemTropical" style="margin-right: 10px; width: 18px; height: 18px; cursor: pointer;">
                                <span style="font-weight: 600;">Use Tropical (Western)</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="button-group">
                <button class="btn-primary" id="calculateBtn">Calculate Ephemeris & Chart</button>
                <button class="btn-secondary" id="printBtn">Print / Export</button>
            </div>
        </div>

        <div class="results">
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Calculating high-precision planetary positions...</p>
            </div>

            <div class="error" id="error"></div>

            <div id="resultsContainer" style="display: none;">
                <div class="info-panel">
                    <h3>Calculation Details</h3>
                    <p><strong>Date & Time:</strong> <span id="calculationDateTime"></span></p>
                    <div id="calculationAyanamsa"></div>
                    <p><strong>Timestamp:</strong> <span id="calculationTimestamp"></span></p>
                </div>

                <div class="toggle-options">
                    <label>
                        <input type="checkbox" id="toggleTropical" checked>
                        Show Tropical Positions
                    </label>
                    <label>
                        <input type="checkbox" id="toggleDecimal">
                        Show Decimal Degrees
                    </label>
                </div>

                <table id="ephemerisTable">
                    <thead>
                        <tr>
                            <th>Planet</th>
                            <th class="tropical-col">Tropical (DMS)</th>
                            <th>Sidereal (DMS)</th>
                            <th>Rashi</th>
                            <th>Deg in Rashi (DMS)</th>
                            <th>Nakshatra</th>
                            <th>Pada</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="ephemerisBody">
                    </tbody>
                </table>

                <div class="chart-container" id="chartContainer" style="display: none;">
                    <div class="chart-header">
                        <h2>East Indian (Bengali) Style Birth Chart</h2>
                        <div class="chart-info">
                            <p><strong>Ascendant (Lagna):</strong> <span id="ascendantInfo">--</span></p>
                            <p><strong>Chart for:</strong> <span id="chartDateInfo">--</span></p>
                        </div>
                    </div>
                    <svg id="horoscopeChart" viewBox="0 0 600 600" xmlns="http://www.w3.org/2000/svg">
                        <!-- Chart will be drawn here by JavaScript -->
                    </svg>
                </div>
            </div>
        </div>

        <footer>
            <p>High-Precision Vedic Astrology Ephemeris ‚Ä¢ Arc-Second Accuracy ‚Ä¢ NASA JPL Horizons API & VSOP87</p>
            <p>¬© 2024 ‚Ä¢ For educational and research purposes</p>
        </footer>
    </div>

    <script>
        // ==========================================
        // CONSTANTS AND CONFIGURATION
        // ==========================================

        const HORIZONS_API = 'https://ssd.jpl.nasa.gov/api/horizons.api';

        // NAIF ID codes for celestial bodies
        const NAIF_CODES = {
            'Sun': '10',
            'Moon': '301',
            'Mercury': '199',
            'Venus': '299',
            'Mars': '499',
            'Jupiter': '599',
            'Saturn': '699',
            'Rahu': 'Moon', // Calculated from Moon's node
            'Ketu': 'Moon'
        };

        // Ayanamsa values at epoch J2000.0 (January 1, 2000, 12:00 TT)
        const AYANAMSA_J2000 = {
            lahiri: { deg: 23, min: 51, sec: 10.38 },
            raman: { deg: 22, min: 3, sec: 32.26 },
            krishnamurti: { deg: 23, min: 56, sec: 52.45 },
            yukteshwar: { deg: 21, min: 0, sec: 0 }
        };

        // Rate of precession (arcseconds per year)
        const PRECESSION_RATE = 50.2685; // arcseconds per tropical year

        // Vedic zodiac signs (Rashis)
        const RASHIS = [
            { sanskrit: 'Mesha', english: 'Aries' },
            { sanskrit: 'Vrishabha', english: 'Taurus' },
            { sanskrit: 'Mithuna', english: 'Gemini' },
            { sanskrit: 'Karka', english: 'Cancer' },
            { sanskrit: 'Simha', english: 'Leo' },
            { sanskrit: 'Kanya', english: 'Virgo' },
            { sanskrit: 'Tula', english: 'Libra' },
            { sanskrit: 'Vrishchika', english: 'Scorpio' },
            { sanskrit: 'Dhanu', english: 'Sagittarius' },
            { sanskrit: 'Makara', english: 'Capricorn' },
            { sanskrit: 'Kumbha', english: 'Aquarius' },
            { sanskrit: 'Meena', english: 'Pisces' }
        ];

        // Nakshatras (27 lunar mansions)
        const NAKSHATRAS = [
            'Ashwini', 'Bharani', 'Krittika', 'Rohini', 'Mrigashira',
            'Ardra', 'Punarvasu', 'Pushya', 'Ashlesha', 'Magha',
            'Purva Phalguni', 'Uttara Phalguni', 'Hasta', 'Chitra', 'Swati',
            'Vishakha', 'Anuradha', 'Jyeshtha', 'Mula', 'Purva Ashadha',
            'Uttara Ashadha', 'Shravana', 'Dhanishta', 'Shatabhisha', 'Purva Bhadrapada',
            'Uttara Bhadrapada', 'Revati'
        ];

        // ==========================================
        // HIGH-PRECISION DMS CONVERSION FUNCTIONS
        // ==========================================

        /**
         * Convert decimal degrees to DMS with arc-second precision
         * @param {number} decimalDegrees - Decimal degrees
         * @returns {object} {deg, min, sec, formatted}
         */
        function decimalToDMS(decimalDegrees) {
            // Normalize to 0-360 range
            let normalized = decimalDegrees % 360;
            if (normalized < 0) normalized += 360;

            const degrees = Math.floor(normalized);
            const minutesDecimal = (normalized - degrees) * 60;
            const minutes = Math.floor(minutesDecimal);
            const seconds = (minutesDecimal - minutes) * 60;

            return {
                deg: degrees,
                min: minutes,
                sec: seconds,
                formatted: `${degrees}¬∞ ${String(minutes).padStart(2, '0')}' ${seconds.toFixed(2)}"`
            };
        }

        /**
         * Convert DMS to decimal degrees with full precision
         * @param {number} deg - Degrees
         * @param {number} min - Minutes
         * @param {number} sec - Seconds
         * @returns {number} Decimal degrees
         */
        function dmsToDecimal(deg, min, sec) {
            return deg + (min / 60.0) + (sec / 3600.0);
        }

        /**
         * Normalize angle to 0-360 range
         * @param {number} angle - Angle in degrees
         * @returns {number} Normalized angle
         */
        function normalizeAngle(angle) {
            let normalized = angle % 360;
            if (normalized < 0) normalized += 360;
            return normalized;
        }

        // ==========================================
        // AYANAMSA CALCULATIONS
        // ==========================================

        /**
         * Calculate ayanamsa for a given date and type
         * @param {Date} date - Target date
         * @param {string} type - Ayanamsa type
         * @param {object} customValues - Custom DMS values if type is 'custom'
         * @returns {number} Ayanamsa in decimal degrees
         */
        function calculateAyanamsa(date, type, customValues = null) {
            if (type === 'custom' && customValues) {
                return dmsToDecimal(customValues.deg, customValues.min, customValues.sec);
            }

            // J2000.0 epoch (January 1, 2000, 12:00 TT)
            const j2000 = new Date('2000-01-01T12:00:00Z');
            const epochYear = 2000.0;

            // Calculate years from J2000.0
            const millisecondsPerYear = 365.25 * 24 * 60 * 60 * 1000;
            const yearsDiff = (date - j2000) / millisecondsPerYear;

            // Base ayanamsa at J2000.0
            const base = AYANAMSA_J2000[type];
            if (!base) return 24.0; // Default fallback

            const baseDecimal = dmsToDecimal(base.deg, base.min, base.sec);

            // Calculate precession
            const precessionDegrees = (PRECESSION_RATE * yearsDiff) / 3600.0;

            return baseDecimal + precessionDegrees;
        }

        /**
         * Update ayanamsa display
         */
        function updateAyanamsaDisplay() {
            const type = document.getElementById('ayanamsaType').value;
            const dateInput = document.getElementById('dateInput').value;
            const date = dateInput ? new Date(dateInput) : new Date();

            let ayanamsa;
            if (type === 'custom') {
                const deg = parseFloat(document.getElementById('customDeg').value) || 0;
                const min = parseFloat(document.getElementById('customMin').value) || 0;
                const sec = parseFloat(document.getElementById('customSec').value) || 0;
                ayanamsa = dmsToDecimal(deg, min, sec);
            } else {
                ayanamsa = calculateAyanamsa(date, type);
            }

            const dms = decimalToDMS(ayanamsa);
            document.getElementById('ayanamsaDisplay').innerHTML =
                `<strong>Ayanamsa:</strong> ${dms.formatted} (${ayanamsa.toFixed(6)}¬∞)`;
        }

        // ==========================================
        // VEDIC ASTROLOGY CALCULATIONS
        // ==========================================

        /**
         * Calculate Rashi (zodiac sign) from sidereal longitude
         * @param {number} siderealLong - Sidereal longitude in degrees
         * @returns {object} {index, sanskrit, english, degreeInRashi}
         */
        function calculateRashi(siderealLong) {
            const rashiIndex = Math.floor(siderealLong / 30);
            const degreeInRashi = siderealLong % 30;

            return {
                index: rashiIndex,
                sanskrit: RASHIS[rashiIndex].sanskrit,
                english: RASHIS[rashiIndex].english,
                degreeInRashi: degreeInRashi
            };
        }

        /**
         * Calculate Nakshatra and Pada from sidereal longitude
         * @param {number} siderealLong - Sidereal longitude in degrees
         * @returns {object} {nakshatra, pada, index}
         */
        function calculateNakshatra(siderealLong) {
            // Each nakshatra spans 13¬∞ 20' (13.33333¬∞ exactly)
            const nakshatraSpan = 360.0 / 27.0; // 13.333333...
            const nakshatraIndex = Math.floor(siderealLong / nakshatraSpan);

            // Each pada is 1/4 of a nakshatra (3¬∞ 20' or 3.33333¬∞)
            const positionInNakshatra = siderealLong % nakshatraSpan;
            const padaIndex = Math.floor(positionInNakshatra / (nakshatraSpan / 4));

            return {
                nakshatra: NAKSHATRAS[nakshatraIndex],
                pada: padaIndex + 1,
                index: nakshatraIndex
            };
        }

        /**
         * Determine if planet is retrograde from velocity
         * @param {number} velocity - Orbital velocity
         * @returns {boolean}
         */
        function isRetrograde(velocity) {
            return velocity < 0;
        }

        // ==========================================
        // ASCENDANT AND HOUSE CALCULATIONS
        // ==========================================

        /**
         * Calculate Local Sidereal Time (LST)
         * @param {Date} date - UTC date/time
         * @param {number} longitude - Geographic longitude in degrees (East positive)
         * @returns {number} Local Sidereal Time in degrees
         */
        function calculateLocalSiderealTime(date, longitude) {
            const jd = calculateJulianDay(date);
            const T = calculateJulianCenturies(jd);

            // Jean Meeus formula for Greenwich Mean Sidereal Time at 0h UT
            // Œ∏‚ÇÄ = 100.46061837 + 36000.770053608√óT + 0.000387933√óT¬≤ - T¬≥/38710000
            const GMST0 = 100.46061837 + 36000.770053608 * T +
                         0.000387933 * T * T - (T * T * T) / 38710000.0;

            // Normalize to 0-360
            let gmst0 = GMST0 % 360;
            if (gmst0 < 0) gmst0 += 360;

            // Add time since 0h UT to get GMST at current time
            const hour = date.getUTCHours();
            const minute = date.getUTCMinutes();
            const second = date.getUTCSeconds();
            const decimalHours = hour + minute / 60.0 + second / 3600.0;

            // 1 mean solar hour = 1.00273790935 sidereal hours
            // In degrees: 15¬∞ √ó 1.00273790935 = 15.04107 degrees per mean solar hour
            const gmst = gmst0 + decimalHours * 15.04106717867;

            // Local Sidereal Time = GMST + longitude
            let lst = gmst + longitude;

            // Normalize to 0-360
            lst = lst % 360;
            if (lst < 0) lst += 360;

            return lst;
        }

        /**
         * Calculate Ascendant (Lagna) using correct spherical astronomy formula
         * Based on JPL Horizons methodology
         * @param {Date} date - UTC date/time
         * @param {number} latitude - Geographic latitude in degrees (North +, South -)
         * @param {number} longitude - Geographic longitude in degrees (East +, West -)
         * @param {number} ayanamsa - Ayanamsa value in degrees
         * @returns {object} {tropical, sidereal, rashi}
         */
        function calculateAscendant(date, latitude, longitude, ayanamsa) {
            // Calculate Local Sidereal Time (LST) in degrees
            const lst = calculateLocalSiderealTime(date, longitude);

            // Calculate obliquity of ecliptic (Œµ)
            const T = calculateJulianCenturies(calculateJulianDay(date));
            const epsilon = 23.439291 - 0.0130042 * T - 0.00000164 * T * T + 0.000000504 * T * T * T;

            // Debug logging for Parashara's Light test case
            console.log('DEBUG Ascendant Calculation:');
            console.log('  UTC Date:', date.toUTCString());
            console.log('  Latitude (œÜ):', latitude, '¬∞');
            console.log('  Longitude (Œª):', longitude, '¬∞');
            console.log('  LST (Œ∏):', lst.toFixed(4), '¬∞ =', (lst / 15).toFixed(4), 'hours');
            console.log('  Obliquity (Œµ):', epsilon.toFixed(6), '¬∞');
            console.log('  Ayanamsa:', ayanamsa.toFixed(6), '¬∞');

            // Convert to radians
            const theta = lst * Math.PI / 180.0;        // Œ∏ = LST in radians
            const phi = latitude * Math.PI / 180.0;     // œÜ = latitude in radians
            const eps = epsilon * Math.PI / 180.0;      // Œµ = obliquity in radians

            // Spherical astronomy formula for ascendant (eastern horizon):
            // y = cos(Œ∏)
            // x = -(sin(Œ∏)*cos(Œµ) + tan(œÜ)*sin(Œµ))
            // Œª_tr = atan2(y, x)
            const y = Math.cos(theta);
            const x = -(Math.sin(theta) * Math.cos(eps) + Math.tan(phi) * Math.sin(eps));

            console.log('  y = cos(Œ∏):', y.toFixed(6));
            console.log('  x = -(sin(Œ∏)*cos(Œµ) + tan(œÜ)*sin(Œµ)):', x.toFixed(6));

            let ascendant = Math.atan2(y, x) * 180.0 / Math.PI;

            // Normalize to 0-360
            if (ascendant < 0) ascendant += 360;

            console.log('  Tropical Ascendant:', ascendant.toFixed(4), '¬∞');

            // This is tropical ascendant
            const tropicalAsc = ascendant;

            // Convert to sidereal by subtracting ayanamsa
            const siderealAsc = normalizeAngle(tropicalAsc - ayanamsa);

            console.log('  Sidereal Ascendant:', siderealAsc.toFixed(4), '¬∞');

            return {
                tropical: tropicalAsc,
                sidereal: siderealAsc,
                rashi: calculateRashi(siderealAsc)
            };
        }

        /**
         * Calculate house cusps using Whole Sign House system
         * (Most common in Vedic astrology)
         * @param {number} ascendantSidereal - Sidereal ascendant in degrees
         * @returns {Array} Array of 12 house cusps (start degrees)
         */
        function calculateHouseCuspsWholeSign(ascendantSidereal) {
            // In Whole Sign houses, each house is exactly 30¬∞
            // House 1 starts at the sign containing the ascendant
            const ascRashiIndex = Math.floor(ascendantSidereal / 30);
            const house1Start = ascRashiIndex * 30;

            const cusps = [];
            for (let i = 0; i < 12; i++) {
                cusps.push(normalizeAngle(house1Start + (i * 30)));
            }

            return cusps;
        }

        /**
         * Determine which house a planet is in
         * @param {number} planetLongitude - Sidereal longitude of planet
         * @param {Array} houseCusps - Array of house cusp positions
         * @returns {number} House number (1-12)
         */
        function getPlanetHouse(planetLongitude, houseCusps) {
            for (let i = 0; i < 12; i++) {
                const currentCusp = houseCusps[i];
                const nextCusp = houseCusps[(i + 1) % 12];

                if (nextCusp > currentCusp) {
                    // Normal case
                    if (planetLongitude >= currentCusp && planetLongitude < nextCusp) {
                        return i + 1;
                    }
                } else {
                    // Wraps around 360/0 boundary
                    if (planetLongitude >= currentCusp || planetLongitude < nextCusp) {
                        return i + 1;
                    }
                }
            }
            return 1; // Fallback
        }

        // ==========================================
        // EAST INDIAN CHART RENDERING
        // ==========================================

        /**
         * Draw East Indian (Bengali) style horoscope chart
         * @param {Array} planetData - Array of planet positions with house numbers
         * @param {object} ascendant - Ascendant information
         */
        function drawEastIndianChart(planetData, ascendant) {
            const svg = document.getElementById('horoscopeChart');
            svg.innerHTML = ''; // Clear previous chart

            const size = 600;
            const outerSize = 500;
            const offset = (size - outerSize) / 2;

            // Scale factor for 300x300 grid to 500x500
            const scale = outerSize / 300;

            // Helper function to scale coordinates
            const s = (coord) => offset + (coord * scale);

            // Draw outer square frame
            const outerRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            outerRect.setAttribute('x', offset);
            outerRect.setAttribute('y', offset);
            outerRect.setAttribute('width', outerSize);
            outerRect.setAttribute('height', outerSize);
            outerRect.setAttribute('fill', 'white');
            outerRect.setAttribute('stroke', '#1e40af');
            outerRect.setAttribute('stroke-width', '3');
            svg.appendChild(outerRect);

            // Define all lines for the East Indian chart
            const lines = [
                // Vertical divisions
                { x1: 100, y1: 0, x2: 100, y2: 300 },   // Vertical line 1
                { x1: 200, y1: 0, x2: 200, y2: 300 },   // Vertical line 2

                // Horizontal divisions
                { x1: 0, y1: 100, x2: 300, y2: 100 },   // Horizontal line 1
                { x1: 0, y1: 200, x2: 300, y2: 200 },   // Horizontal line 2

                // Diagonal lines
                { x1: 0, y1: 0, x2: 100, y2: 100 },     // Diagonal 1: Top-left
                { x1: 200, y1: 100, x2: 300, y2: 0 },   // Diagonal 2: Top-right
                { x1: 200, y1: 200, x2: 300, y2: 300 }, // Diagonal 3: Bottom-right
                { x1: 0, y1: 300, x2: 100, y2: 200 }    // Diagonal 4: Bottom-left
            ];

            // Draw all lines
            lines.forEach(line => {
                const lineEl = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                lineEl.setAttribute('x1', s(line.x1));
                lineEl.setAttribute('y1', s(line.y1));
                lineEl.setAttribute('x2', s(line.x2));
                lineEl.setAttribute('y2', s(line.y2));
                lineEl.setAttribute('stroke', '#1e40af');
                lineEl.setAttribute('stroke-width', '2');
                svg.appendChild(lineEl);
            });

            // Define house positions (center points for text placement)
            // Based on exact house boundary coordinates
            // Houses are arranged according to East Indian (Bengali) style
            const housePositions = [
                { x: 150, y: 25, house: 1 },    // House 1: Top middle
                { x: 50, y: 25, house: 2 },     // House 2: Top-left
                { x: 25, y: 50, house: 3 },     // House 3: Left upper
                { x: 25, y: 150, house: 4 },    // House 4: Middle-left
                { x: 25, y: 250, house: 5 },    // House 5: Left lower
                { x: 50, y: 275, house: 6 },    // House 6: Bottom-left
                { x: 150, y: 275, house: 7 },   // House 7: Bottom middle
                { x: 250, y: 275, house: 8 },   // House 8: Bottom-right
                { x: 275, y: 250, house: 9 },   // House 9: Right lower
                { x: 275, y: 150, house: 10 },  // House 10: Middle-right
                { x: 275, y: 50, house: 11 },   // House 11: Right upper
                { x: 250, y: 25, house: 12 }    // House 12: Top-right
            ];

            // Draw house numbers and planets
            housePositions.forEach(pos => {
                const houseNum = pos.house;

                // Draw house number
                const houseText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                houseText.setAttribute('x', s(pos.x));
                houseText.setAttribute('y', s(pos.y) - 30);
                houseText.setAttribute('text-anchor', 'middle');
                houseText.setAttribute('font-size', '14');
                houseText.setAttribute('font-weight', 'bold');
                houseText.setAttribute('fill', '#64748b');
                houseText.textContent = `[${houseNum}]`;
                svg.appendChild(houseText);

                // Find planets in this house
                const planetsInHouse = planetData.filter(p => p.house === houseNum);

                let yOffset = s(pos.y) - 5;
                planetsInHouse.forEach(planet => {
                    // Sinhala script abbreviations for planets
                    const planetAbbrev = {
                        'Sun': '‡∂ª',       // Ra (Ravi)
                        'Moon': '‡∂†',      // Cha (Chandra)
                        'Mercury': '‡∂∂‡∑î',  // Bu (Budha)
                        'Venus': '‡∑É‡∑í',    // Si (Sikuru)
                        'Mars': '‡∂ö‡∑î',     // Ku (Kuja)
                        'Jupiter': '‡∂ú‡∑î',  // Gu (Guru)
                        'Saturn': '‡∑Å',    // Sha (Shani)
                        'Rahu': '‡∂ª‡∑è',     // Ra (Rahu)
                        'Ketu': '‡∂ö‡∑ö'      // Ke (Ketu)
                    }[planet.name] || planet.name.substring(0, 2);

                    const degInRashi = planet.rashi.degreeInRashi;
                    const dms = decimalToDMS(degInRashi);
                    const degOnly = dms.deg;

                    const retrograde = planet.retrograde ? '(R)' : '';

                    const planetText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    planetText.setAttribute('x', s(pos.x));
                    planetText.setAttribute('y', yOffset);
                    planetText.setAttribute('text-anchor', 'middle');
                    planetText.setAttribute('font-size', '12');
                    planetText.setAttribute('font-weight', '600');
                    planetText.setAttribute('fill', getPlanetColor(planet.name));
                    planetText.textContent = `${planetAbbrev} ${degOnly}¬∞ ${retrograde}`;
                    svg.appendChild(planetText);

                    yOffset += 18;
                });

                // Add Ascendant marker in House 1
                if (houseNum === 1) {
                    const ascDeg = Math.floor(ascendant.rashi.degreeInRashi);
                    const ascText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    ascText.setAttribute('x', s(pos.x));
                    ascText.setAttribute('y', yOffset);
                    ascText.setAttribute('text-anchor', 'middle');
                    ascText.setAttribute('font-size', '11');
                    ascText.setAttribute('font-weight', 'bold');
                    ascText.setAttribute('fill', '#059669');
                    ascText.textContent = `As ${ascDeg}¬∞`;
                    svg.appendChild(ascText);
                }
            });
        }

        /**
         * Get color for planet based on type
         * @param {string} planetName - Planet name
         * @returns {string} Color code
         */
        function getPlanetColor(planetName) {
            const colors = {
                'Sun': '#f59e0b',
                'Moon': '#f59e0b',
                'Mercury': '#10b981',
                'Venus': '#10b981',
                'Mars': '#10b981',
                'Jupiter': '#3b82f6',
                'Saturn': '#3b82f6',
                'Rahu': '#8b5cf6',
                'Ketu': '#8b5cf6'
            };
            return colors[planetName] || '#333';
        }

        /**
         * Helper function to set location
         * @param {number} lat - Latitude
         * @param {number} lon - Longitude
         */
        function setLocation(lat, lon) {
            document.getElementById('latitudeInput').value = lat;
            document.getElementById('longitudeInput').value = lon;
        }

        // ==========================================
        // HIGH-PRECISION ASTRONOMICAL ALGORITHMS
        // ==========================================

        /**
         * Calculate Julian Day Number with high precision
         * @param {Date} date - Input date
         * @returns {number} Julian Day Number
         */
        function calculateJulianDay(date) {
            const year = date.getUTCFullYear();
            const month = date.getUTCMonth() + 1;
            const day = date.getUTCDate();
            const hour = date.getUTCHours();
            const minute = date.getUTCMinutes();
            const second = date.getUTCSeconds();

            let y = year;
            let m = month;

            if (m <= 2) {
                y -= 1;
                m += 12;
            }

            const a = Math.floor(y / 100);
            const b = 2 - a + Math.floor(a / 4);

            const jd = Math.floor(365.25 * (y + 4716)) +
                      Math.floor(30.6001 * (m + 1)) +
                      day + b - 1524.5;

            const dayFraction = (hour + minute / 60.0 + second / 3600.0) / 24.0;

            return jd + dayFraction;
        }

        /**
         * Calculate Julian centuries from J2000.0
         * @param {number} jd - Julian Day
         * @returns {number} Julian centuries
         */
        function calculateJulianCenturies(jd) {
            return (jd - 2451545.0) / 36525.0;
        }

        /**
         * Calculate Sun's ecliptic longitude using high-precision algorithm
         * Based on VSOP87 theory
         * @param {number} T - Julian centuries from J2000.0
         * @returns {object} {longitude, latitude, distance, velocity}
         */
        function calculateSunPosition(T) {
            // Mean longitude of the Sun
            const L0 = 280.46646 + 36000.76983 * T + 0.0003032 * T * T;

            // Mean anomaly
            const M = 357.52911 + 35999.05029 * T - 0.0001537 * T * T;
            const Mrad = M * Math.PI / 180.0;

            // Equation of center
            const C = (1.914602 - 0.004817 * T - 0.000014 * T * T) * Math.sin(Mrad) +
                     (0.019993 - 0.000101 * T) * Math.sin(2 * Mrad) +
                     0.000289 * Math.sin(3 * Mrad);

            // True longitude
            const trueLong = L0 + C;

            // Apparent longitude (with aberration correction)
            const omega = 125.04 - 1934.136 * T;
            const lambda = trueLong - 0.00569 - 0.00478 * Math.sin(omega * Math.PI / 180.0);

            return {
                longitude: normalizeAngle(lambda),
                velocity: 0.9856 // degrees per day (always direct)
            };
        }

        /**
         * Calculate Moon's ecliptic longitude using high-precision algorithm
         * @param {number} T - Julian centuries from J2000.0
         * @returns {object} {longitude, velocity}
         */
        function calculateMoonPosition(T) {
            // Moon's mean longitude
            const L = 218.3164477 + 481267.88123421 * T - 0.0015786 * T * T +
                     T * T * T / 538841.0 - T * T * T * T / 65194000.0;

            // Mean elongation
            const D = 297.8501921 + 445267.1114034 * T - 0.0018819 * T * T +
                     T * T * T / 545868.0 - T * T * T * T / 113065000.0;

            // Sun's mean anomaly
            const M = 357.5291092 + 35999.0502909 * T - 0.0001536 * T * T +
                     T * T * T / 24490000.0;

            // Moon's mean anomaly
            const Mprime = 134.9633964 + 477198.8675055 * T + 0.0087414 * T * T +
                          T * T * T / 69699.0 - T * T * T * T / 14712000.0;

            // Moon's argument of latitude
            const F = 93.2720950 + 483202.0175233 * T - 0.0036539 * T * T -
                     T * T * T / 3526000.0 + T * T * T * T / 863310000.0;

            // Convert to radians
            const Drad = D * Math.PI / 180.0;
            const Mrad = M * Math.PI / 180.0;
            const Mprimerada = Mprime * Math.PI / 180.0;
            const Frad = F * Math.PI / 180.0;

            // Main periodic terms for longitude
            let sigmaL = 6.288774 * Math.sin(Mprimerada) +
                        1.274027 * Math.sin(2 * Drad - Mprimerada) +
                        0.658314 * Math.sin(2 * Drad) +
                        0.213618 * Math.sin(2 * Mprimerada) -
                        0.185116 * Math.sin(Mrad) -
                        0.114332 * Math.sin(2 * Frad) +
                        0.058793 * Math.sin(2 * Drad - 2 * Mprimerada) +
                        0.057066 * Math.sin(2 * Drad - Mrad - Mprimerada) +
                        0.053322 * Math.sin(2 * Drad + Mprimerada) +
                        0.045758 * Math.sin(2 * Drad - Mrad);

            const longitude = L + sigmaL;

            return {
                longitude: normalizeAngle(longitude),
                velocity: 13.176 // degrees per day (average)
            };
        }

        /**
         * Calculate planetary positions using VSOP87-based algorithms
         * NOTE: These are simplified approximations. For perfect accuracy matching
         * professional software like Parashara's Light, you need Swiss Ephemeris or similar.
         * @param {string} planet - Planet name
         * @param {number} T - Julian centuries from J2000.0
         * @returns {object} {longitude, velocity}
         */
        function calculatePlanetPosition(planet, T) {
            // Simplified VSOP87 formulas - good for approximate calculations
            // For exact match with Parashara's Light, use NASA API or Swiss Ephemeris

            const planetData = {
                'Mercury': {
                    L0: 252.250906, n: 149472.6746358,
                    coeffs: [
                        [0.387098, 4.092339, 26087.90314],
                        [0.024906, 2.151769, 0.0]
                    ]
                },
                'Venus': {
                    L0: 181.979801, n: 58517.8156748,
                    coeffs: [
                        [0.723330, 1.602145, 10213.28555],
                        [0.004627, 3.176896, 0.0]
                    ]
                },
                'Mars': {
                    L0: 355.433000, n: 19140.299331,
                    coeffs: [
                        [1.523688, 6.203481, 3340.61243],
                        [0.093312, 5.863170, 0.0]
                    ]
                },
                'Jupiter': {
                    L0: 34.351519, n: 3034.90567,
                    coeffs: [
                        [5.202603, 0.599548, 529.69097],
                        [0.048392, 1.047699, 0.0]
                    ]
                },
                'Saturn': {
                    L0: 50.077444, n: 1222.11386,
                    coeffs: [
                        [9.554747, 0.873056, 213.29910],
                        [0.055500, 4.837997, 0.0]
                    ]
                }
            };

            const data = planetData[planet];
            if (!data) return { longitude: 0, velocity: 0 };

            // Mean longitude
            let L = data.L0 + data.n * T;

            // Add periodic terms
            for (const coeff of data.coeffs) {
                const [a, b, c] = coeff;
                L += a * Math.sin(b + c * T);
            }

            // Velocity (degrees per day)
            const velocity = data.n / 36525.0; // Convert from degrees per century to degrees per day

            return {
                longitude: normalizeAngle(L),
                velocity: velocity
            };
        }

        /**
         * Calculate Rahu (Moon's North Node) position
         * @param {number} T - Julian centuries from J2000.0
         * @returns {object} {longitude, velocity}
         */
        function calculateRahuKetu(T) {
            // Moon's ascending node (Rahu)
            const omega = 125.04452 - 1934.136261 * T + 0.0020708 * T * T +
                         T * T * T / 450000.0;

            return {
                rahu: {
                    longitude: normalizeAngle(omega),
                    velocity: -0.05295 // degrees per day (retrograde)
                },
                ketu: {
                    longitude: normalizeAngle(omega + 180),
                    velocity: -0.05295 // degrees per day (retrograde)
                }
            };
        }

        /**
         * Detect retrograde motion based on planetary velocity and position
         * @param {string} planet - Planet name
         * @param {number} velocity - Daily motion in degrees
         * @param {number} T - Julian centuries from J2000.0
         * @returns {boolean} True if retrograde
         */
        function detectRetrograde(planet, velocity, T) {
            // For superior planets (Mars, Jupiter, Saturn), check if velocity is negative
            // For inferior planets (Mercury, Venus), more complex calculation

            if (planet === 'Sun' || planet === 'Moon') {
                return false; // Never retrograde
            }

            if (planet === 'Rahu' || planet === 'Ketu') {
                return true; // Always retrograde
            }

            // Simplified retrograde detection
            const avgMotions = {
                'Mercury': 4.092, 'Venus': 1.602, 'Mars': 0.524,
                'Jupiter': 0.083, 'Saturn': 0.033
            };

            const avgMotion = avgMotions[planet] || 0;
            return velocity < (avgMotion * 0.5); // Threshold for retrograde
        }

        // ==========================================
        // NASA JPL HORIZONS API INTEGRATION (WITH FALLBACK)
        // ==========================================

        /**
         * Fetch planetary data from NASA Horizons API
         * @param {string} target - NAIF ID code
         * @param {Date} date - Target date
         * @returns {Promise<object>} Planet data
         */
        async function fetchHorizonsData(target, date) {
            // Format date for Horizons API (YYYY-MM-DD HH:MM:SS)
            const year = date.getUTCFullYear();
            const month = String(date.getUTCMonth() + 1).padStart(2, '0');
            const day = String(date.getUTCDate()).padStart(2, '0');
            const hour = String(date.getUTCHours()).padStart(2, '0');
            const minute = String(date.getUTCMinutes()).padStart(2, '0');
            const second = String(date.getUTCSeconds()).padStart(2, '0');
            const dateStr = `${year}-${month}-${day} ${hour}:${minute}:${second}`;

            // Build Horizons API URL with parameters
            const params = new URLSearchParams({
                format: 'text',
                COMMAND: target,
                OBJ_DATA: 'NO',
                MAKE_EPHEM: 'YES',
                EPHEM_TYPE: 'OBSERVER',
                CENTER: '500@399',  // Geocentric (Earth center)
                START_TIME: dateStr,
                STOP_TIME: dateStr,
                STEP_SIZE: '1d',
                QUANTITIES: '31',  // Astrometric RA & DEC
                REF_SYSTEM: 'ICRF',
                CAL_FORMAT: 'CAL',
                TIME_DIGITS: 'FRACSEC',
                ANG_FORMAT: 'DEG',
                APPARENT: 'AIRLESS',
                RANGE_UNITS: 'AU',
                SUPPRESS_RANGE_RATE: 'NO',
                SKIP_DAYLT: 'NO',
                EXTRA_PREC: 'YES',
                CSV_FORMAT: 'YES'
            });

            const url = `${HORIZONS_API}?${params}`;

            console.log(`[NASA API] Fetching target ${target} for date ${dateStr}`);
            console.log(`[NASA API] URL: ${url.substring(0, 100)}...`);

            try {
                const response = await fetch(url);

                console.log(`[NASA API] Response status: ${response.status} ${response.statusText}`);
                console.log(`[NASA API] Response headers:`, {
                    contentType: response.headers.get('content-type'),
                    corsHeaders: {
                        'access-control-allow-origin': response.headers.get('access-control-allow-origin'),
                        'access-control-allow-methods': response.headers.get('access-control-allow-methods')
                    }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`[NASA API] HTTP Error ${response.status}:`, errorText.substring(0, 500));
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const text = await response.text();
                console.log(`[NASA API] Response length: ${text.length} characters`);
                console.log(`[NASA API] First 200 chars:`, text.substring(0, 200));

                return parseHorizonsResponse(text, target);
            } catch (error) {
                console.error(`[NASA API] Error fetching target ${target}:`, error.message);
                console.error(`[NASA API] Error type:`, error.name);
                if (error.message.includes('CORS') || error.message.includes('Failed to fetch')) {
                    console.error(`[NASA API] CORS or network error - this is a browser security restriction`);
                }
                throw error;
            }
        }

        /**
         * Parse Horizons API response to extract ecliptic longitude
         * @param {string} response - API response text
         * @param {string} target - Target ID (for error logging)
         * @returns {object} Parsed data with longitude and velocity
         */
        function parseHorizonsResponse(response, target) {
            console.log(`[NASA API] Parsing response for target ${target}`);

            // Look for the data section between $$SOE and $$EOE
            const soeIndex = response.indexOf('$$SOE');
            const eoeIndex = response.indexOf('$$EOE');

            if (soeIndex === -1 || eoeIndex === -1) {
                console.error(`[NASA API] Data markers not found. Response preview:`, response.substring(0, 500));
                throw new Error('Could not find data markers ($$SOE/$$EOE) in Horizons response');
            }

            const dataSection = response.substring(soeIndex + 5, eoeIndex).trim();
            console.log(`[NASA API] Data section (first 200 chars):`, dataSection.substring(0, 200));

            const lines = dataSection.split('\n').filter(line => line.trim());

            if (lines.length === 0) {
                console.error(`[NASA API] No data lines found in section`);
                throw new Error('No ephemeris data found in response');
            }

            console.log(`[NASA API] Found ${lines.length} data lines`);

            // Parse the CSV data - first data line
            const dataLine = lines[0].trim();
            console.log(`[NASA API] Parsing data line:`, dataLine);

            const parts = dataLine.split(',').map(s => s.trim());
            console.log(`[NASA API] Split into ${parts.length} parts:`, parts.slice(0, 6));

            if (parts.length < 4) {
                console.error(`[NASA API] Insufficient columns. Got ${parts.length}, need at least 4`);
                throw new Error(`Insufficient data in Horizons response (${parts.length} columns)`);
            }

            // Extract RA and DEC from the response
            // Typically columns 2 and 3 contain RA and DEC in degrees
            const ra = parseFloat(parts[2]);
            const dec = parseFloat(parts[3]);

            console.log(`[NASA API] Extracted RA=${ra}¬∞, DEC=${dec}¬∞`);

            if (isNaN(ra) || isNaN(dec)) {
                console.error(`[NASA API] Invalid RA/DEC values: RA="${parts[2]}", DEC="${parts[3]}"`);
                throw new Error('Invalid RA/DEC data from Horizons');
            }

            // Convert RA/DEC to ecliptic longitude
            const eclipticLong = convertRADecToEcliptic(ra, dec);
            console.log(`[NASA API] Converted to ecliptic longitude: ${eclipticLong.toFixed(4)}¬∞`);

            // Extract velocity if available (typically in later columns)
            let velocity = 0;
            if (parts.length > 5) {
                const raRate = parseFloat(parts[4]) || 0;
                velocity = raRate; // RA rate as proxy for velocity
            }

            return {
                longitude: eclipticLong,
                velocity: velocity
            };
        }

        /**
         * Convert RA/DEC to ecliptic longitude
         * @param {number} ra - Right Ascension in degrees
         * @param {number} dec - Declination in degrees
         * @returns {number} Ecliptic longitude in degrees
         */
        function convertRADecToEcliptic(ra, dec) {
            // Obliquity of ecliptic (epsilon) for J2000.0
            const epsilon = 23.439291; // degrees
            const epsilonRad = epsilon * Math.PI / 180.0;

            // Convert to radians
            const raRad = ra * Math.PI / 180.0;
            const decRad = dec * Math.PI / 180.0;

            // Convert equatorial to ecliptic coordinates
            // Œª = arctan2(sin(Œ±)cos(Œµ) + tan(Œ¥)sin(Œµ), cos(Œ±))
            const sinLambda = Math.sin(raRad) * Math.cos(epsilonRad) +
                              Math.tan(decRad) * Math.sin(epsilonRad);
            const cosLambda = Math.cos(raRad);

            let lambda = Math.atan2(sinLambda, cosLambda) * 180.0 / Math.PI;

            // Normalize to 0-360
            if (lambda < 0) lambda += 360;

            return lambda;
        }

        /**
         * Fetch all planetary positions - tries NASA API first, falls back to local calculations
         * @param {Date} date - Target date
         * @param {boolean} useNASA - Whether to use NASA API or local calculations
         * @returns {Promise<Array>} Array of planet data
         */
        async function fetchAllPlanets(date, useNASA = true) {
            const results = [];

            // Calculate Julian Day and Julian Centuries for fallback
            const jd = calculateJulianDay(date);
            const T = calculateJulianCenturies(jd);

            // Fetch data for each planet
            const planetList = [
                { name: 'Sun', naifId: '10' },
                { name: 'Moon', naifId: '301' },
                { name: 'Mercury', naifId: '199' },
                { name: 'Venus', naifId: '299' },
                { name: 'Mars', naifId: '499' },
                { name: 'Jupiter', naifId: '599' },
                { name: 'Saturn', naifId: '699' }
            ];

            for (const planet of planetList) {
                let data;

                if (useNASA) {
                    try {
                        // Try NASA API first
                        console.log(`[Fetch] Attempting NASA API for ${planet.name} (NAIF ID: ${planet.naifId})`);
                        data = await fetchHorizonsData(planet.naifId, date);
                        console.log(`[Fetch] ‚úì SUCCESS: ${planet.name} from NASA API: ${data.longitude.toFixed(4)}¬∞`);
                    } catch (error) {
                        console.warn(`[Fetch] ‚úó FAILED: NASA API for ${planet.name}`);
                        console.warn(`[Fetch] Error details:`, error.message);
                        console.warn(`[Fetch] Falling back to local VSOP87 calculation`);
                        // Fallback to local calculation
                        if (planet.name === 'Sun') {
                            data = calculateSunPosition(T);
                        } else if (planet.name === 'Moon') {
                            data = calculateMoonPosition(T);
                        } else {
                            data = calculatePlanetPosition(planet.name, T);
                        }
                        console.log(`[Fetch] Local calculation result for ${planet.name}: ${data.longitude.toFixed(4)}¬∞`);
                    }
                } else {
                    // Use local calculations
                    console.log(`[Fetch] Using local VSOP87 calculation for ${planet.name} (user selected)`);
                    if (planet.name === 'Sun') {
                        data = calculateSunPosition(T);
                    } else if (planet.name === 'Moon') {
                        data = calculateMoonPosition(T);
                    } else {
                        data = calculatePlanetPosition(planet.name, T);
                    }
                    console.log(`[Fetch] Local result for ${planet.name}: ${data.longitude.toFixed(4)}¬∞`);
                }

                results.push({
                    name: planet.name,
                    tropical: data.longitude,
                    velocity: data.velocity
                });
            }

            // Rahu and Ketu - always use local calculation (not available in NASA for single date)
            const nodes = calculateRahuKetu(T);
            results.push({
                name: 'Rahu',
                tropical: nodes.rahu.longitude,
                velocity: nodes.rahu.velocity
            });

            results.push({
                name: 'Ketu',
                tropical: nodes.ketu.longitude,
                velocity: nodes.ketu.velocity
            });

            return results;
        }

        // ==========================================
        // UI FUNCTIONS
        // ==========================================

        /**
         * Convert local time in a specific timezone to UTC Date object
         * @param {string} dateStr - Date string (YYYY-MM-DD)
         * @param {string} timeStr - Time string (HH:MM:SS)
         * @param {string} timezone - Timezone identifier
         * @returns {Date} UTC Date object
         */
        function convertLocalToUTC(dateStr, timeStr, timezone) {
            // Timezone offset mapping (in hours, positive = East of UTC)
            const timezoneOffsets = {
                'UTC': 0,
                'America/New_York': -5,    // EST (ignoring DST for simplicity)
                'America/Chicago': -6,     // CST
                'America/Denver': -7,      // MST
                'America/Los_Angeles': -8, // PST
                'Europe/London': 0,        // GMT
                'Europe/Paris': 1,         // CET
                'Asia/Kolkata': 5.5,       // IST
                'Asia/Dubai': 4,           // GST
                'Asia/Tokyo': 9,           // JST
                'Australia/Sydney': 10     // AEST (ignoring DST)
            };

            const offset = timezoneOffsets[timezone] || 0;

            // Parse the date and time components
            const [year, month, day] = dateStr.split('-').map(Number);
            const [hour, minute, second] = timeStr.split(':').map(Number);

            // Create UTC date by subtracting the timezone offset
            // If local time is 01:07 in IST (UTC+5:30), UTC time is 01:07 - 5:30 = 19:37 previous day
            const utcHour = hour - offset;
            const utcMinute = minute - ((offset % 1) * 60); // Handle fractional hours like IST (+5.5)

            // Create date in UTC
            const utcDate = new Date(Date.UTC(year, month - 1, day, utcHour, utcMinute, second || 0));

            return utcDate;
        }

        /**
         * Initialize the application
         */
        function initialize() {
            // Set test case date and time (Parashara's Light verification)
            // 1985/10/03 1:07 AM IST at 7.2954¬∞ N, 80.2366¬∞ E
            document.getElementById('dateInput').value = '1985-10-03';
            document.getElementById('timeInput').value = '01:07:00';

            // Set timezone to IST (already default in HTML)
            document.getElementById('timezoneInput').value = 'Asia/Kolkata';

            // Set location (Sri Lanka coordinates)
            document.getElementById('latitudeInput').value = 7.2954;
            document.getElementById('longitudeInput').value = 80.2366;

            // Set current date/time display
            updateCurrentDateTime();
            setInterval(updateCurrentDateTime, 1000);

            // Event listeners
            document.getElementById('calculateBtn').addEventListener('click', calculateEphemeris);
            document.getElementById('printBtn').addEventListener('click', () => window.print());

            document.getElementById('ayanamsaType').addEventListener('change', (e) => {
                const isCustom = e.target.value === 'custom';
                document.getElementById('customAyanamsaInputs').classList.toggle('active', isCustom);
                updateAyanamsaDisplay();
            });

            document.getElementById('customDeg').addEventListener('input', updateAyanamsaDisplay);
            document.getElementById('customMin').addEventListener('input', updateAyanamsaDisplay);
            document.getElementById('customSec').addEventListener('input', updateAyanamsaDisplay);
            document.getElementById('dateInput').addEventListener('change', updateAyanamsaDisplay);

            document.getElementById('toggleTropical').addEventListener('change', toggleTropicalColumns);
            document.getElementById('toggleDecimal').addEventListener('change', toggleDecimalDisplay);

            // Initial ayanamsa display
            updateAyanamsaDisplay();
        }

        /**
         * Update current date/time display
         */
        function updateCurrentDateTime() {
            const now = new Date();
            document.getElementById('currentDateTime').textContent =
                `Current: ${now.toUTCString()}`;
        }

        /**
         * Main calculation function
         */
        async function calculateEphemeris() {
            // Get inputs
            const dateInput = document.getElementById('dateInput').value;
            const timeInput = document.getElementById('timeInput').value;
            const timezone = document.getElementById('timezoneInput').value;
            const ayanamsaType = document.getElementById('ayanamsaType').value;
            const latitude = parseFloat(document.getElementById('latitudeInput').value) || 28.6139;
            const longitude = parseFloat(document.getElementById('longitudeInput').value) || 77.2090;

            // Get user-selected options
            const useNASA = document.querySelector('input[name="dataSource"]:checked').value === 'nasa';
            const useSidereal = document.querySelector('input[name="coordSystem"]:checked').value === 'sidereal';

            if (!dateInput || !timeInput) {
                showError('Please select both date and time');
                return;
            }

            // Convert local time to UTC using the selected timezone
            const targetDate = convertLocalToUTC(dateInput, timeInput, timezone);

            console.log('Input Date/Time:', dateInput, timeInput, 'in timezone:', timezone);
            console.log('Converted to UTC:', targetDate.toUTCString());

            // Calculate ayanamsa
            let ayanamsa;
            if (ayanamsaType === 'custom') {
                const deg = parseFloat(document.getElementById('customDeg').value) || 0;
                const min = parseFloat(document.getElementById('customMin').value) || 0;
                const sec = parseFloat(document.getElementById('customSec').value) || 0;
                ayanamsa = dmsToDecimal(deg, min, sec);
            } else {
                ayanamsa = calculateAyanamsa(targetDate, ayanamsaType);
            }

            // Show loading
            document.getElementById('loading').classList.add('active');
            document.getElementById('error').classList.remove('active');
            document.getElementById('resultsContainer').style.display = 'none';
            document.getElementById('chartContainer').style.display = 'none';
            document.getElementById('calculateBtn').disabled = true;

            try {
                // Fetch planetary data with selected data source
                const planets = await fetchAllPlanets(targetDate, useNASA);

                // Calculate Ascendant based on coordinate system
                let ascendant;
                if (useSidereal) {
                    // Sidereal: subtract ayanamsa from tropical ascendant
                    ascendant = calculateAscendant(targetDate, latitude, longitude, ayanamsa);
                } else {
                    // Tropical: don't subtract ayanamsa
                    ascendant = calculateAscendant(targetDate, latitude, longitude, 0);
                }

                // Calculate house cusps based on selected coordinate system
                const houseCusps = useSidereal ?
                    calculateHouseCuspsWholeSign(ascendant.sidereal) :
                    calculateHouseCuspsWholeSign(ascendant.tropical);

                // Calculate positions and Vedic data with house placement
                const ephemerisData = planets.map(planet => {
                    let primaryLongitude, secondaryLongitude;

                    if (useSidereal) {
                        // Sidereal mode: primary is sidereal, secondary is tropical
                        primaryLongitude = normalizeAngle(planet.tropical - ayanamsa);
                        secondaryLongitude = planet.tropical;
                    } else {
                        // Tropical mode: primary is tropical, secondary is sidereal
                        primaryLongitude = planet.tropical;
                        secondaryLongitude = normalizeAngle(planet.tropical - ayanamsa);
                    }

                    const rashi = calculateRashi(primaryLongitude);
                    const nakshatra = calculateNakshatra(primaryLongitude);
                    const retrograde = isRetrograde(planet.velocity);
                    const house = getPlanetHouse(primaryLongitude, houseCusps);

                    return {
                        name: planet.name,
                        tropical: planet.tropical,
                        sidereal: normalizeAngle(planet.tropical - ayanamsa),
                        primaryLongitude: primaryLongitude,
                        useSidereal: useSidereal,
                        rashi: rashi,
                        nakshatra: nakshatra,
                        retrograde: retrograde,
                        velocity: planet.velocity,
                        house: house
                    };
                });

                // Debug: Compare with Parashara's Light expected results
                if (dateInput === '1985-10-03' && timeInput === '01:07:00') {
                    console.log('=== PARASHARA\'S LIGHT VERIFICATION ===');
                    console.log('Expected vs Calculated (Sidereal Degrees):');

                    const expected = {
                        'Ascendant': 93.0472,  // Cancer 03:02:50 = 90 + 3.0472
                        'Sun': 165.7892,       // Virgo 15:47:21 = 150 + 15.7892
                        'Moon': 27.5164,       // Aries 27:30:59
                        'Mars': 140.6792,      // Leo 20:40:45 = 120 + 20.6792
                        'Mercury': 173.4261,   // Virgo 23:25:34 = 150 + 23.4261
                        'Jupiter': 283.5000,   // Capricorn 13:30:00 = 270 + 13.5
                        'Venus': 139.3183,     // Leo 19:19:06 = 120 + 19.3183
                        'Saturn': 211.3747,    // Scorpio 01:22:29 = 210 + 1.3747
                        'Rahu': 15.7075,       // Aries 15:42:27
                        'Ketu': 195.7075       // Libra 15:42:27 = 180 + 15.7075
                    };

                    console.log(`Ascendant: Expected ${expected.Ascendant.toFixed(4)}¬∞ vs Calculated ${ascendant.sidereal.toFixed(4)}¬∞ (Diff: ${Math.abs(expected.Ascendant - ascendant.sidereal).toFixed(4)}¬∞)`);

                    ephemerisData.forEach(planet => {
                        if (expected[planet.name]) {
                            const diff = Math.abs(expected[planet.name] - planet.sidereal);
                            console.log(`${planet.name}: Expected ${expected[planet.name].toFixed(4)}¬∞ vs Calculated ${planet.sidereal.toFixed(4)}¬∞ (Diff: ${diff.toFixed(4)}¬∞)`);
                        }
                    });
                    console.log('========================================');
                }

                // Display results
                displayResults(ephemerisData, targetDate, ayanamsa, ayanamsaType, ascendant, useSidereal, useNASA, timezone, dateInput, timeInput);

            } catch (error) {
                showError(`Error fetching planetary data: ${error.message}`);
            } finally {
                document.getElementById('loading').classList.remove('active');
                document.getElementById('calculateBtn').disabled = false;
            }
        }

        /**
         * Display results in table
         */
        function displayResults(data, date, ayanamsa, ayanamsaType, ascendant, useSidereal, useNASA, timezone, localDateStr, localTimeStr) {
            const tbody = document.getElementById('ephemerisBody');
            tbody.innerHTML = '';

            // Planet color classes
            const colorClasses = {
                'Sun': 'sun-moon',
                'Moon': 'sun-moon',
                'Mercury': 'inner-planet',
                'Venus': 'inner-planet',
                'Mars': 'inner-planet',
                'Jupiter': 'outer-planet',
                'Saturn': 'outer-planet',
                'Rahu': 'node',
                'Ketu': 'node'
            };

            data.forEach(planet => {
                const row = document.createElement('tr');

                const tropicalDMS = decimalToDMS(planet.tropical);
                const siderealDMS = decimalToDMS(planet.sidereal);
                const degInRashiDMS = decimalToDMS(planet.rashi.degreeInRashi);

                const colorClass = colorClasses[planet.name] || '';
                const retrogradeText = planet.retrograde ? '<span class="retrograde">R</span>' : 'D';

                row.innerHTML = `
                    <td class="planet-name ${colorClass}">${planet.name}</td>
                    <td class="tropical-col dms-value">${tropicalDMS.formatted}</td>
                    <td class="dms-value">${siderealDMS.formatted}</td>
                    <td class="rashi">${planet.rashi.english}<br><small>(${planet.rashi.sanskrit})</small></td>
                    <td class="dms-value">${degInRashiDMS.formatted}</td>
                    <td class="nakshatra">${planet.nakshatra.nakshatra}</td>
                    <td style="text-align: center;">${planet.nakshatra.pada}</td>
                    <td style="text-align: center;">${retrogradeText}</td>
                `;

                tbody.appendChild(row);
            });

            // Update info panel with coordinate system and data source information
            const ayanamsaDMS = decimalToDMS(ayanamsa);
            const coordSystemText = useSidereal ? 'Sidereal (Vedic)' : 'Tropical (Western)';
            const dataSourceText = useNASA ? 'NASA JPL Horizons API' : 'Local VSOP87 Calculations';

            // Display both local time and UTC time
            const localTimeDisplay = `${localDateStr} ${localTimeStr} (${timezone})`;
            const utcTimeDisplay = date.toUTCString();

            document.getElementById('calculationDateTime').innerHTML =
                `<strong>Local Time:</strong> ${localTimeDisplay}<br><strong>UTC Time:</strong> ${utcTimeDisplay}`;
            document.getElementById('calculationAyanamsa').innerHTML =
                `<strong>Ayanamsa:</strong> ${ayanamsaType.charAt(0).toUpperCase() + ayanamsaType.slice(1)} - ${ayanamsaDMS.formatted} (${ayanamsa.toFixed(6)}¬∞)<br>` +
                `<strong>Coordinate System:</strong> ${coordSystemText}<br>` +
                `<strong>Data Source:</strong> ${dataSourceText}`;
            document.getElementById('calculationTimestamp').textContent = new Date().toUTCString();

            // Update chart information
            if (ascendant) {
                // Use the appropriate ascendant based on coordinate system
                const displayAscendant = useSidereal ? ascendant.sidereal : ascendant.tropical;
                const displayRashi = calculateRashi(displayAscendant);
                const ascDMS = decimalToDMS(displayAscendant);
                document.getElementById('ascendantInfo').textContent =
                    `${ascDMS.formatted} - ${displayRashi.english} (${displayRashi.sanskrit}) [${coordSystemText}]`;
                document.getElementById('chartDateInfo').textContent = date.toUTCString();

                // Draw the East Indian chart
                drawEastIndianChart(data, ascendant);

                // Show chart container
                document.getElementById('chartContainer').style.display = 'block';
            }

            // Show results
            document.getElementById('resultsContainer').style.display = 'block';
        }

        /**
         * Show error message
         */
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.classList.add('active');
        }

        /**
         * Toggle tropical column visibility
         */
        function toggleTropicalColumns() {
            const checked = document.getElementById('toggleTropical').checked;
            const cols = document.querySelectorAll('.tropical-col');
            cols.forEach(col => {
                col.style.display = checked ? '' : 'none';
            });
        }

        /**
         * Toggle decimal degree display
         */
        function toggleDecimalDisplay() {
            // This would add decimal values to the display
            // Implementation can be added to show both DMS and decimal
            alert('Decimal display toggle - can be implemented to show decimal values alongside DMS');
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>
